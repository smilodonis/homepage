<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Enhanced Data Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.23.0/cdn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; }
        h1, h2 { text-align: center; color: #1a1a1a; }
        .dashboard { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-container { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .chart-container h3 { margin-top: 0; }
        .stock-info { font-size: 0.9em; color: #666; margin-bottom: 10px; text-align: left;}
        .current-price { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; }
        .market-status { font-size: 1em; font-weight: normal; vertical-align: middle; margin-left: 10px;}
        .last-updated { font-size: 0.8em; color: #999; }
        .nav { background-color: #fff; padding: 10px 20px; border-bottom: 1px solid #ddd; text-align: center; }
        .nav-button { background: none; border: none; font-size: 1.1em; padding: 10px 20px; cursor: pointer; color: #333; transition: color 0.3s; }
        .nav-button.active { color: #007aff; border-bottom: 2px solid #007aff; }
        .page { display: none; }
        .page.active { display: block; }
        #news-container { max-width: 800px; margin: 20px auto; }
        .news-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease-in-out;
        }
        .news-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .news-item h3 {
            margin-top: 0;
            font-size: 1.25em;
        }
        .news-item a {
            text-decoration: none;
            color: #007aff;
            font-weight: 600;
        }
        .news-item a:hover {
            text-decoration: underline;
        }
        .news-item p {
            color: #555;
            line-height: 1.6;
        }
        .news-item small {
            font-size: 0.85em;
            color: #888;
        }
        .price-info {
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 10px;
        }
        .daily-change {
            font-size: 0.9em;
            font-weight: bold;
        }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .big-chart-container {
            margin: 30px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 80%;
        }
        .back-button {
            background: none;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        .timeframe-controls {
            text-align: center;
            margin-bottom: 15px;
        }
        .timeframe-button {
            background-color: #f0f2f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 15px;
            margin: 0 5px;
            cursor: pointer;
        }
        .timeframe-button.active {
            background-color: #007aff;
            color: #fff;
            border-color: #007aff;
        }
        /* Portfolio Dashboard */
        .portfolio { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: #fff; border: 1px solid #e8e8e8; border-radius: 10px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
        .card h4 { margin: 0 0 6px 0; font-size: 0.95em; color: #555; }
        .card .value { font-size: 1.6em; font-weight: 700; }
        .card .delta { font-size: 0.95em; font-weight: 600; }
        .delta.positive { color: #28a745; }
        .delta.negative { color: #dc3545; }
        .portfolio-controls { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; margin: 10px 0 20px; }
        .portfolio-controls .left, .portfolio-controls .right { display: flex; align-items: center; gap: 8px; }
        .portfolio-controls .tf-btn { background:#f0f2f5; border:1px solid #ddd; border-radius:6px; padding:6px 10px; cursor:pointer; }
        .portfolio-controls .tf-btn.active { background:#007aff; color:#fff; border-color:#007aff; }
        .portfolio-charts { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .portfolio-charts { grid-template-columns: 1fr; } }
        .table { width: 100%; border-collapse: collapse; background:#fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e8e8e8; }
        .table th, .table td { padding: 10px 12px; border-bottom: 1px solid #eee; text-align: right; }
        .table th:first-child, .table td:first-child { text-align: left; }
        .table tr:hover { background: #fafafa; }
        .section-title { margin: 20px 0 10px; }
    </style>
</head>
<body>
    <div class="nav">
        <button class="nav-button active" onclick="showPage('dashboard')">Dashboard</button>
        <button class="nav-button" onclick="showPage('charts')">Charts</button>
        <button class="nav-button" onclick="showPage('news')">News</button>
    </div>

    <div id="dashboard" class="page active">
        <h1>Dashboard</h1>
        <div class="portfolio">
            <div class="cards">
                <div class="card"><h4>Total Net Worth</h4><div class="value" id="nw-total">-</div><div class="delta" id="nw-delta"></div></div>
                <div class="card"><h4>Stocks Value</h4><div class="value" id="nw-stocks">-</div><div class="delta" id="nw-stocks-delta"></div></div>
                <div class="card"><h4>Crypto Value</h4><div class="value" id="nw-crypto">-</div><div class="delta" id="nw-crypto-delta"></div></div>
                <div class="card"><h4>Private Companies</h4><div class="value" id="nw-companies">-</div><div class="delta" id="nw-companies-delta"></div></div>
                <div class="card"><h4>Other</h4><div class="value" id="nw-other">-</div><div class="delta" id="nw-other-delta"></div></div>
            </div>
            <div class="portfolio-controls">
                <div class="left">
                    <label><input type="checkbox" id="inc-stocks" checked> Stocks</label>
                    <label><input type="checkbox" id="inc-crypto" checked> Crypto</label>
                    <label><input type="checkbox" id="inc-companies" checked> Companies</label>
                    <label><input type="checkbox" id="inc-other" checked> Other</label>
                </div>
                <div class="right">
                    <button class="tf-btn" data-days="30">1M</button>
                    <button class="tf-btn active" data-days="90">3M</button>
                    <button class="tf-btn" data-days="180">6M</button>
                    <button class="tf-btn" data-days="365">1Y</button>
                </div>
            </div>
            <div class="portfolio-charts">
                <div class="card"><h4 class="section-title">Net Worth Over Time</h4><canvas id="networth-chart"></canvas></div>
                <div class="card"><h4 class="section-title">Allocation</h4><canvas id="allocation-chart"></canvas></div>
            </div>

            <h2 class="section-title">Holdings</h2>
            <h3>Stocks</h3>
            <table class="table" id="table-stocks">
                <thead><tr><th>Ticker</th><th>Shares</th><th>Price</th><th>Value</th><th>P/L</th></tr></thead>
                <tbody></tbody>
            </table>

            <h3>Crypto</h3>
            <table class="table" id="table-crypto">
                <thead><tr><th>Symbol</th><th>Units</th><th>Price</th><th>Value</th><th>P/L</th></tr></thead>
                <tbody></tbody>
            </table>

            <h3>Companies</h3>
            <table class="table" id="table-companies">
                <thead><tr><th>Name</th><th>Stake</th><th>Latest Valuation</th><th>Value</th><th>P/L</th></tr></thead>
                <tbody></tbody>
            </table>

            <h3>Other</h3>
            <table class="table" id="table-other">
                <thead><tr><th>Name</th><th>Latest Valuation</th><th>Value</th><th>P/L</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="charts" class="page">
        <h1>Charts</h1>
        <div class="dashboard-content">
            <h2>Stock Market <span id="market-status" class="market-status"></span></h2>
            <div id="stock-charts" class="charts-grid"></div>
            <h2>Cryptocurrency</h2>
            <div id="crypto-charts" class="charts-grid"></div>
        </div>
        <div id="big-chart-container" class="big-chart-container" style="display: none;">
            <button id="back-button" class="back-button">‚Üê Back to all charts</button>
            <h2 id="big-chart-title"></h2>
            <div class="timeframe-controls">
                <button class="timeframe-button" data-period="7d">7D</button>
                <button class="timeframe-button" data-period="1mo">1M</button>
                <button class="timeframe-button active" data-period="6mo">6M</button>
                <button class="timeframe-button" data-period="1y">1Y</button>
                <button class="timeframe-button" data-period="max">Max</button>
            </div>
            <canvas id="big-chart"></canvas>
        </div>
    </div>

    <div id="news" class="page">
        <h1>Market News</h1>
        <div id="news-container"></div>
    </div>

    <script>
        const stocks = ['AAPL', 'MSFT', 'GOOGL', 'BITO', 'TSLA', 'NVDA'];
        const cryptos = [
            { id: 'BTC', name: 'Bitcoin' },
            { id: 'ETH', name: 'Ethereum' },
            { id: 'SOL', name: 'Solana' },
            { id: 'XRP', name: 'XRP (Ripple)' },
            { id: 'DOGE', name: 'Dogecoin' },
            { id: 'ADA', name: 'Cardano' }
        ];
        const charts = {}; // To hold chart instances
        let bigChartInstance;

        function createChart(canvasId, labels, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                    }]
                },
                options: {
                    scales: {
                        x: { 
                            type: 'time', 
                            time: { 
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM'
                                }
                            } 
                        },
                        y: { ticks: { callback: (value) => `$${value.toLocaleString()}` } }
                    }
                }
            });
        }

        function showBigChart(id, name, type) {
            document.getElementById('big-chart-container').style.display = 'block';
            document.getElementById('big-chart-title').textContent = `${name} Price Chart`;

            const timeframeButtons = document.querySelectorAll('.timeframe-button');
            timeframeButtons.forEach(button => {
                button.onclick = () => {
                    timeframeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    fetchBigChartData(id, type, button.dataset.period);
                };
            });

            fetchBigChartData(id, type, '6mo');
        }

        function hideBigChart() {
            document.getElementById('big-chart-container').style.display = 'none';
            if (bigChartInstance) {
                bigChartInstance.destroy();
                bigChartInstance = null;
            }
        }



        function fetchBigChartData(id, type, period) {
            let historyUrl;
            if (type === 'stock') {
                historyUrl = `/api/stock/${id}?period=${period}`;
            } else {
                historyUrl = `/api/crypto/history/${id}?period=${period}`;
            }

            fetch(historyUrl)
                .then(response => response.json())
                .then(data => {
                    let dates, prices;
                    if (type === 'stock') {
                        const series = Array.isArray(data) ? data : (data && data.history ? data.history : []);
                        dates = series.map(item => new Date(item.Date));
                        prices = series.map(item => item.Close);
                    } else {
                        dates = data.map(item => new Date(item[0]));
                        prices = data.map(item => item[1]);
                    }

                    if (bigChartInstance) {
                        bigChartInstance.data.labels = dates;
                        bigChartInstance.data.datasets[0].data = prices;
                        bigChartInstance.update();
                    } else {
                        const ctx = document.getElementById('big-chart').getContext('2d');
                        bigChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: dates,
                                datasets: [{
                                    label: `${id} Price`,
                                    data: prices,
                                    borderColor: 'rgba(0, 122, 255, 1)',
                                    borderWidth: 2,
                                    fill: true,
                                    backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                    pointRadius: 0
                                }]
                            },
                            options: {
                                scales: {
                                    x: { type: 'time', time: { unit: 'day' } },
                                    y: { ticks: { callback: (value) => `$${value.toLocaleString()}` } }
                                }
                            }
                        });
                    }
                });
        }


        function updateChart(canvasId, labels, data) {
            if (charts[canvasId]) {
                charts[canvasId].data.labels = labels;
                charts[canvasId].data.datasets[0].data = data;
                charts[canvasId].update();
            }
        }

        function fetchStockData(ticker) {
            fetch(`/api/stock/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById(`price-${ticker}`).textContent = `$${data.info.currentPrice.toFixed(2)}`;
                    
                    const changeEl = document.getElementById(`change-${ticker}`);
                    const change = data.info.change.toFixed(2);
                    const changePercent = data.info.changePercent.toFixed(2);
                    
                    changeEl.textContent = `${change} (${changePercent}%)`;
                    changeEl.className = 'daily-change';
                    if (data.info.change > 0) {
                        changeEl.classList.add('positive');
                    } else if (data.info.change < 0) {
                        changeEl.classList.add('negative');
                    }

                    const infoDiv = document.getElementById(`info-${ticker}`);
                    infoDiv.innerHTML = `
                        <strong>${data.info.shortName || ticker}</strong> (${data.info.symbol})<br>
                        Sector: ${data.info.sector || 'N/A'}<br>
                        Market Cap: ${data.info.marketCap ? (data.info.marketCap / 1e9).toFixed(2) + 'B' : 'N/A'}<br>
                        P/E Ratio: ${data.info.trailingPE ? data.info.trailingPE.toFixed(2) : 'N/A'}
                    `;
                    
                    const dates = data.history.map(item => new Date(item.Date));
                    const prices = data.history.map(item => item.Close);
                    const canvasId = `chart-${ticker}`;

                    if (charts[canvasId]) {
                        updateChart(canvasId, dates, prices);
                    } else {
                        createChart(canvasId, dates, prices, `${ticker} Closing Price`, 'rgba(75, 192, 192, 1)');
                    }
                    document.getElementById(`updated-${ticker}`).textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                });
        }

        function fetchCryptoData() {
            const cryptoIds = cryptos.map(c => c.id).join(',');
            fetch(`/api/crypto/prices?fsyms=${cryptoIds}`)
                .then(response => response.json())
                .then(prices => {
                    cryptos.forEach(coin => {
                        if (prices[coin.id]) {
                            const priceEl = document.getElementById(`price-${coin.id}`);
                            if (priceEl) {
                                priceEl.textContent = `$${prices[coin.id].price.toLocaleString()}`;
                            }
                            const changeEl = document.getElementById(`change-${coin.id}`);
                            if (changeEl) {
                                const change = prices[coin.id].change.toFixed(2);
                                const changePercent = prices[coin.id].changePercent.toFixed(2);
                                changeEl.textContent = `${change} (${changePercent}%)`;
                                changeEl.className = 'daily-change';
                                if (prices[coin.id].change > 0) {
                                    changeEl.classList.add('positive');
                                } else if (prices[coin.id].change < 0) {
                                    changeEl.classList.add('negative');
                                }
                            }
                            const updatedEl = document.getElementById(`updated-${coin.id}`);
                            if (updatedEl) {
                                updatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                            }
                        }
                    });
                });

            cryptos.forEach(coin => {
                fetch(`/api/crypto/history/${coin.id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data || data.length === 0) return;
                        const dates = data.map(item => new Date(item[0]));
                        const prices = data.map(item => item[1]);
                        const canvasId = `chart-${coin.id}`;
                        
                        if (charts[canvasId]) {
                            updateChart(canvasId, dates, prices);
                        } else {
                            createChart(canvasId, dates, prices, `${coin.name} Price`, 'rgba(255, 159, 64, 1)');
                        }
                    });
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(button => button.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelector(`.nav-button[onclick="showPage('${pageId}')"]`).classList.add('active');

            if (pageId === 'charts') {
                initializeCharts();
            }
        }

        function initializeCharts() {
            const stockContainer = document.getElementById('stock-charts');
            if (!stockContainer) return; 
            
            stocks.forEach(ticker => {
                if (document.getElementById(`chart-${ticker}`)) return;
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.innerHTML = `
                    <h3>${ticker}</h3>
                    <div class="price-info">
                        <div class="current-price" id="price-${ticker}">-</div>
                        <div class="daily-change" id="change-${ticker}"></div>
                    </div>
                    <div class="stock-info" id="info-${ticker}">Loading info...</div>
                    <canvas id="chart-${ticker}"></canvas>
                    <div class="last-updated" id="updated-${ticker}"></div>`;
                chartDiv.onclick = () => showBigChart(ticker, ticker, 'stock');
                stockContainer.appendChild(chartDiv);
                fetchStockData(ticker);
            });

            const cryptoContainer = document.getElementById('crypto-charts');
            if (!cryptoContainer) return;
            cryptos.forEach(coin => {
                if (document.getElementById(`chart-${coin.id}`)) return;
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.innerHTML = `
                    <h3>${coin.name}</h3>
                    <div class="price-info">
                        <div class="current-price" id="price-${coin.id}">-</div>
                        <div class="daily-change" id="change-${coin.id}"></div>
                    </div>
                    <canvas id="chart-${coin.id}"></canvas>
                    <div class="last-updated" id="updated-${coin.id}"></div>`;
                chartDiv.onclick = () => showBigChart(coin.id, coin.name, 'crypto');
                cryptoContainer.appendChild(chartDiv);
            });
            fetchCryptoData();
        }

        document.getElementById('back-button').onclick = hideBigChart;


        function fetchNews() {
            const newsContainer = document.getElementById('news-container');
            fetch('/api/news')
                .then(response => response.json())
                .then(newsItems => {
                    newsContainer.innerHTML = '';
                    newsItems.forEach(item => {
                        const newsDiv = document.createElement('div');
                        newsDiv.className = 'news-item';
                        newsDiv.innerHTML = `
                            <h3><a href="${item.link}" target="_blank">${item.title}</a></h3>
                            <p>${item.summary}</p>
                            <small><strong>Source:</strong> ${item.source} | <strong>Published:</strong> ${new Date(item.published).toLocaleString()}</small>
                        `;
                        newsContainer.appendChild(newsDiv);
                    });
                });
        }

        function refreshData() {
            stocks.forEach(fetchStockData);
            fetchCryptoData();
        }

        let refreshInterval;
        let lastMarketStatus = null;

        function updateMarketStatus() {
            const statusEl = document.getElementById('market-status');
            const now = new Date();
            const nyTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));

            const day = nyTime.getDay();
            const hour = nyTime.getHours();
            const minute = nyTime.getMinutes();

            const isWeekday = day >= 1 && day <= 5;
            const marketOpen = hour > 9 || (hour === 9 && minute >= 30);
            const marketClose = hour >= 16;
            const isOpen = isWeekday && marketOpen && !marketClose;

            if (isOpen !== lastMarketStatus) {
                lastMarketStatus = isOpen;
                
                if (refreshInterval) clearInterval(refreshInterval);

                if (isOpen) {
                    refreshInterval = setInterval(refreshData, 60000); // 1 minute
                } else {
                    refreshInterval = setInterval(refreshData, 3600000); // 1 hour
                }
                refreshData(); 
            }

            statusEl.style.color = isOpen ? 'green' : 'black';

            if (isOpen) {
                const closeTime = new Date(nyTime);
                closeTime.setHours(16, 0, 0, 0);
                const diff = closeTime - nyTime;
                statusEl.textContent = `Closes in: ${formatCountdown(diff)}`;
            } else {
                let openTime = new Date(nyTime);
                if (day === 5 && (hour > 16 || (hour === 16 && minute > 0))) {
                    openTime.setDate(nyTime.getDate() + 3);
                } else if (day === 6) {
                    openTime.setDate(nyTime.getDate() + 2);
                } else if (hour > 16 || (hour === 16 && minute > 0)) {
                     openTime.setDate(nyTime.getDate() + 1);
                }
                openTime.setHours(9, 30, 0, 0);
                const diff = openTime - nyTime;
                statusEl.textContent = `Opens in: ${formatCountdown(diff)}`;
            }
        }

        function formatCountdown(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
            fetchNews();
            setInterval(updateMarketStatus, 1000);
            updateMarketStatus();
            showPage('dashboard');
            initializePortfolio();
        });

        // === Portfolio Dashboard Logic ===
        const portfolio = {
            stocks: [
                { ticker: 'AAPL', shares: 20, costBasis: 150 },
                { ticker: 'NVDA', shares: 6, costBasis: 400 },
                { ticker: 'MSFT', shares: 8, costBasis: 300 },
            ],
            cryptos: [
                { symbol: 'BTC', units: 0.25, costBasis: 30000 },
                { symbol: 'ETH', units: 2.5, costBasis: 1500 },
            ],
            companies: [
                { name: 'Acme Startup', stakePercent: 1.2, latestRoundValuationUSD: 50000000, valueHistory: [
                    [new Date().setMonth(new Date().getMonth()-6), 450000],
                    [new Date().setMonth(new Date().getMonth()-3), 520000],
                    [new Date().setMonth(new Date().getMonth()-1), 600000],
                    [Date.now(), 620000],
                ]},
                { name: 'Beta Holdings', stakePercent: 0.8, latestRoundValuationUSD: 120000000, valueHistory: [
                    [new Date().setMonth(new Date().getMonth()-6), 700000],
                    [new Date().setMonth(new Date().getMonth()-2), 750000],
                    [Date.now(), 760000],
                ]}
            ],
            other: [
                { name: 'Savings Account', latestValuationUSD: 25000, valueHistory: [
                    [new Date().setMonth(new Date().getMonth()-6), 20000],
                    [new Date().setMonth(new Date().getMonth()-3), 23000],
                    [Date.now(), 25000],
                ]},
                { name: 'Gold ETF', latestValuationUSD: 12000, valueHistory: [
                    [new Date().setMonth(new Date().getMonth()-6), 11000],
                    [new Date().setMonth(new Date().getMonth()-1), 11800],
                    [Date.now(), 12000],
                ]}
            ]
        };

        let networthChart;
        let allocationChart;
        const portfolioState = {
            days: 90,
            include: { stocks: true, crypto: true, companies: true, other: true },
            stockHistories: {},
            cryptoHistories: {},
            currentPrices: { stocks: {}, crypto: {} }
        };

        function initializePortfolio() {
            document.querySelectorAll('.tf-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    portfolioState.days = parseInt(btn.dataset.days, 10);
                    renderPortfolio();
                });
            });
            document.getElementById('inc-stocks').addEventListener('change', (e) => { portfolioState.include.stocks = e.target.checked; renderPortfolio(); });
            document.getElementById('inc-crypto').addEventListener('change', (e) => { portfolioState.include.crypto = e.target.checked; renderPortfolio(); });
            document.getElementById('inc-companies').addEventListener('change', (e) => { portfolioState.include.companies = e.target.checked; renderPortfolio(); });
            document.getElementById('inc-other').addEventListener('change', (e) => { portfolioState.include.other = e.target.checked; renderPortfolio(); });

            fetchPortfolioData().then(renderPortfolio);
        }

        async function fetchPortfolioData() {
            await Promise.all(portfolio.stocks.map(async (s) => {
                const res = await fetch(`/api/stock/${s.ticker}?period=1y`);
                const data = await res.json();
                const hist = (Array.isArray(data) ? data : data.history) || [];
                portfolioState.stockHistories[s.ticker] = hist.map(it => ({ date: new Date(it.Date), close: it.Close }));
                if (!Array.isArray(data)) {
                    portfolioState.currentPrices.stocks[s.ticker] = data.info.currentPrice;
                } else if (hist.length) {
                    portfolioState.currentPrices.stocks[s.ticker] = hist[hist.length-1].Close;
                }
            }));

            const cryptoSymbols = portfolio.cryptos.map(c => c.symbol).join(',');
            const priceRes = await fetch(`/api/crypto/prices?fsyms=${cryptoSymbols}`);
            const priceJson = await priceRes.json();
            Object.keys(priceJson || {}).forEach(sym => {
                portfolioState.currentPrices.crypto[sym] = priceJson[sym]?.price || 0;
            });

            await Promise.all(portfolio.cryptos.map(async (c) => {
                const res = await fetch(`/api/crypto/history/${c.symbol}?period=1y`);
                const data = await res.json();
                portfolioState.cryptoHistories[c.symbol] = Array.isArray(data) ? data : [];
            }));
        }

        function buildDailyRange(days) {
            const dates = [];
            const start = new Date();
            start.setHours(0,0,0,0);
            start.setDate(start.getDate() - days + 1);
            const cur = new Date(start);
            while (cur <= new Date()) {
                dates.push(new Date(cur));
                cur.setDate(cur.getDate() + 1);
            }
            return dates;
        }

        function formatUSD(v) { return `$${(v || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}`; }

        function computeCurrentValues() {
            let stocksVal = 0, cryptoVal = 0, companiesVal = 0, otherVal = 0;
            portfolio.stocks.forEach(s => { const p = portfolioState.currentPrices.stocks[s.ticker] || 0; stocksVal += p * s.shares; });
            portfolio.cryptos.forEach(c => { const p = portfolioState.currentPrices.crypto[c.symbol] || 0; cryptoVal += p * c.units; });
            portfolio.companies.forEach(co => { const last = co.valueHistory[co.valueHistory.length-1]?.[1] || 0; companiesVal += last; });
            portfolio.other.forEach(o => { const last = o.valueHistory[o.valueHistory.length-1]?.[1] || o.latestValuationUSD || 0; otherVal += last; });
            return { stocksVal, cryptoVal, companiesVal, otherVal, total: stocksVal + cryptoVal + companiesVal + otherVal };
        }

        function computeDailySeries(days) {
            const dates = buildDailyRange(days);
            const dayKey = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);

            const stockMaps = {};
            portfolio.stocks.forEach(s => {
                const map = {};
                (portfolioState.stockHistories[s.ticker] || []).forEach(pt => { map[dayKey(pt.date)] = pt.close; });
                stockMaps[s.ticker] = map;
            });

            const cryptoMaps = {};
            portfolio.cryptos.forEach(c => {
                const map = {};
                (portfolioState.cryptoHistories[c.symbol] || []).forEach(pt => { const d = new Date(pt[0]); map[dayKey(d)] = pt[1]; });
                cryptoMaps[c.symbol] = map;
            });

            const series = [];
            let lastStockVal = 0, lastCryptoVal = 0, lastCompaniesVal = 0, lastOtherVal = 0;
            dates.forEach(d => {
                const k = dayKey(d);
                let sv = 0, cv = 0, pv = 0, ov = 0;
                if (portfolioState.include.stocks) {
                    portfolio.stocks.forEach(s => { const px = stockMaps[s.ticker][k]; sv += (px !== undefined ? px : 0) * s.shares; });
                    if (sv === 0 && lastStockVal) sv = lastStockVal;
                }
                if (portfolioState.include.crypto) {
                    portfolio.cryptos.forEach(c => { const px = cryptoMaps[c.symbol][k]; cv += (px !== undefined ? px : 0) * c.units; });
                    if (cv === 0 && lastCryptoVal) cv = lastCryptoVal;
                }
                if (portfolioState.include.companies) {
                    portfolio.companies.forEach(co => {
                        let val = 0;
                        for (let i=0;i<co.valueHistory.length;i++) {
                            if (co.valueHistory[i][0] <= d.getTime()) val = co.valueHistory[i][1]; else break;
                        }
                        pv += val;
                    });
                    if (pv === 0 && lastCompaniesVal) pv = lastCompaniesVal;
                }
                if (portfolioState.include.other) {
                    portfolio.other.forEach(o => {
                        let val = 0;
                        for (let i=0;i<o.valueHistory.length;i++) {
                            if (o.valueHistory[i][0] <= d.getTime()) val = o.valueHistory[i][1]; else break;
                        }
                        ov += val || 0;
                    });
                    if (ov === 0 && lastOtherVal) ov = lastOtherVal;
                }
                const total = sv + cv + pv + ov;
                series.push([d, total, sv, cv, pv, ov]);
                lastStockVal = sv || lastStockVal;
                lastCryptoVal = cv || lastCryptoVal;
                lastCompaniesVal = pv || lastCompaniesVal;
                lastOtherVal = ov || lastOtherVal;
            });
            return series;
        }

        function renderPortfolio() {
            const { stocksVal, cryptoVal, companiesVal, otherVal, total } = computeCurrentValues();
            const prevSeries = computeDailySeries(Math.min(portfolioState.days+1, 365));
            const last = prevSeries[prevSeries.length-1]?.[1] || 0;
            const prev = prevSeries[prevSeries.length-2]?.[1] || last;
            const delta = last - prev;
            const deltaPct = prev ? (delta/prev)*100 : 0;

            document.getElementById('nw-total').textContent = formatUSD(total);
            const nwDeltaEl = document.getElementById('nw-delta');
            nwDeltaEl.textContent = `${delta>=0?'+':''}${delta.toLocaleString(undefined,{maximumFractionDigits:0})} (${deltaPct.toFixed(2)}%)`;
            nwDeltaEl.className = `delta ${delta>=0?'positive':'negative'}`;
            document.getElementById('nw-stocks').textContent = formatUSD(stocksVal);
            document.getElementById('nw-crypto').textContent = formatUSD(cryptoVal);
            document.getElementById('nw-companies').textContent = formatUSD(companiesVal);
            document.getElementById('nw-other').textContent = formatUSD(otherVal);

            const series = computeDailySeries(portfolioState.days);
            const labels = series.map(s => s[0]);
            const values = series.map(s => s[1]);

            if (networthChart) { networthChart.destroy(); }
            networthChart = new Chart(document.getElementById('networth-chart').getContext('2d'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'Net Worth', data: values, borderColor: '#007aff', backgroundColor: 'rgba(0,122,255,0.1)', fill: true, pointRadius: 0, borderWidth: 2 }] },
                options: { scales: { x: {type:'time', time:{unit:'month'}}, y: { ticks: { callback: (v)=> `$${v.toLocaleString()}` } } }, plugins:{ legend:{display:false} } }
            });

            if (allocationChart) { allocationChart.destroy(); }
            const allocData = [
                portfolioState.include.stocks ? stocksVal : 0,
                portfolioState.include.crypto ? cryptoVal : 0,
                portfolioState.include.companies ? companiesVal : 0,
                portfolioState.include.other ? otherVal : 0,
            ];
            allocationChart = new Chart(document.getElementById('allocation-chart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Stocks','Crypto','Companies','Other'], datasets: [{ data: allocData, backgroundColor: ['#4bc0c0','#ff9f40','#9966ff','#6c757d'] }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            renderTables();
        }

        function renderTables() {
            const tbodyS = document.querySelector('#table-stocks tbody');
            tbodyS.innerHTML = '';
            portfolio.stocks.forEach(s => {
                const price = portfolioState.currentPrices.stocks[s.ticker] || 0;
                const value = price * s.shares;
                const pl = (price - s.costBasis) * s.shares;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${s.ticker}</td><td>${s.shares}</td><td>${formatUSD(price)}</td><td>${formatUSD(value)}</td><td style=\"color:${pl>=0?'#28a745':'#dc3545'}\">${pl>=0?'+':''}${pl.toLocaleString(undefined,{maximumFractionDigits:0})}</td>`;
                tbodyS.appendChild(tr);
            });

            const tbodyC = document.querySelector('#table-crypto tbody');
            tbodyC.innerHTML = '';
            portfolio.cryptos.forEach(c => {
                const price = portfolioState.currentPrices.crypto[c.symbol] || 0;
                const value = price * c.units;
                const pl = (price - c.costBasis) * c.units;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${c.symbol}</td><td>${c.units}</td><td>${formatUSD(price)}</td><td>${formatUSD(value)}</td><td style=\"color:${pl>=0?'#28a745':'#dc3545'}\">${pl>=0?'+':''}${pl.toLocaleString(undefined,{maximumFractionDigits:0})}</td>`;
                tbodyC.appendChild(tr);
            });

            const tbodyP = document.querySelector('#table-companies tbody');
            tbodyP.innerHTML = '';
            portfolio.companies.forEach(co => {
                const latest = co.valueHistory[co.valueHistory.length-1]?.[1] || 0;
                const first = co.valueHistory[0]?.[1] || latest;
                const pl = latest - first;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${co.name}</td><td>${co.stakePercent}%</td><td>${formatUSD(co.latestRoundValuationUSD)}</td><td>${formatUSD(latest)}</td><td style=\"color:${pl>=0?'#28a745':'#dc3545'}\">${pl>=0?'+':''}${pl.toLocaleString(undefined,{maximumFractionDigits:0})}</td>`;
                tbodyP.appendChild(tr);
            });

            const tbodyO = document.querySelector('#table-other tbody');
            tbodyO.innerHTML = '';
            portfolio.other.forEach(o => {
                const latest = o.valueHistory[o.valueHistory.length-1]?.[1] || o.latestValuationUSD || 0;
                const first = o.valueHistory[0]?.[1] || latest;
                const pl = latest - first;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${o.name}</td><td>${formatUSD(o.latestValuationUSD || latest)}</td><td>${formatUSD(latest)}</td><td style=\"color:${pl>=0?'#28a745':'#dc3545'}\">${pl>=0?'+':''}${pl.toLocaleString(undefined,{maximumFractionDigits:0})}</td>`;
                tbodyO.appendChild(tr);
            });
        }
    </script>
</body>
</html>
